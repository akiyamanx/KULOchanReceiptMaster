<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#00d4ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="./manifest.json">
  <title>ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆãƒã‚¹ã‚¿ãƒ¼ - COCOMI</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', 'Segoe UI', sans-serif;
      background-color: #000;
      min-height: 100vh;
      overscroll-behavior-y: contain;
    }

    /* ===== COCOMI SPLASH ===== */
    #cocomi-splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #0a1a2e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 1;
      transition: opacity 0.8s ease;
    }
    
    #cocomi-splash.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .cocomi-content {
      text-align: center;
      padding: 20px;
    }
    
    .cocomi-title {
      font-size: 36px;
      font-weight: 300;
      letter-spacing: 12px;
      color: #ffffff;
      text-shadow: 
        0 0 5px #00d4ff,
        0 0 10px #00d4ff,
        0 0 20px #00d4ff,
        0 0 40px #00d4ff;
      margin-bottom: 24px;
      animation: text-glow 2s ease-in-out infinite;
    }
    
    @keyframes text-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .cocomi-subtitle {
      font-size: 14px;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
    }
    
    .cocomi-sisters {
      font-size: 13px;
      letter-spacing: 0.5px;
      color: rgba(255,255,255,0.5);
    }
    
    .cocomi-sisters .heart {
      color: #ff69b4;
      font-size: 14px;
    }
    
    .cocomi-tagline {
      font-size: 13px;
      letter-spacing: 2px;
      color: rgba(255,255,255,0.6);
      margin-top: 30px;
      font-style: italic;
    }

    /* ===== PERAFCA SPLASH ===== */
    #perafca-splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0d0d1a 0%, #1a1a2e 50%, #0d1a1a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.8s ease;
    }
    
    #perafca-splash.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    #perafca-splash.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .perafca-content {
      text-align: center;
      padding: 20px;
    }
    
    .perafca-title {
      font-size: 28px;
      font-weight: 300;
      letter-spacing: 8px;
      color: #ffffff;
      text-shadow: 0 0 10px #9b59b6, 0 0 20px #9b59b6;
      margin-bottom: 30px;
    }
    
    .perafca-items {
      text-align: left;
      display: inline-block;
    }
    
    .perafca-item {
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      margin: 8px 0;
      letter-spacing: 1px;
    }
    
    .perafca-key {
      color: #00d4ff;
      font-weight: bold;
    }
    
    .perafca-tagline {
      margin-top: 30px;
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .tagline-heart {
      width: 16px;
      height: 16px;
      fill: #ff69b4;
    }

    /* ===== API KEY SCREEN ===== */
    #apikey-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
    }
    
    #apikey-screen.active {
      display: flex;
    }
    
    .apikey-box {
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    .apikey-title {
      font-size: 20px;
      color: #fff;
      margin-bottom: 10px;
    }
    
    .apikey-desc {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .apikey-input {
      width: 100%;
      padding: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    .apikey-input:focus {
      outline: none;
      border-color: #00d4ff;
    }
    
    .apikey-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #00d4ff, #9b59b6);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    /* ===== MAIN APP ===== */
    #main-app {
      display: none;
      min-height: 100vh;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
      padding-bottom: 80px;
    }
    
    #main-app.active {
      display: block;
    }
    
    .app-header {
      background: rgba(0,0,0,0.3);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .app-title {
      font-size: 18px;
      color: #fff;
      font-weight: bold;
    }
    
    .header-btns {
      display: flex;
      gap: 8px;
    }
    
    .header-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }

    /* ===== TAB NAV ===== */
    .tab-nav {
      display: flex;
      background: rgba(0,0,0,0.2);
      padding: 10px;
      gap: 8px;
      overflow-x: auto;
    }
    
    .tab-btn {
      flex-shrink: 0;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .tab-btn.active {
      background: linear-gradient(135deg, #00d4ff, #9b59b6);
      color: #fff;
    }

    /* ===== CAMERA SECTION ===== */
    .camera-section {
      padding: 20px;
      text-align: center;
    }
    
    .camera-btn {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      border: none;
      padding: 20px 40px;
      border-radius: 12px;
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    
    #camera-input { display: none; }
    
    .pending-photos {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    
    .pending-photo {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      border: 2px solid #ffa500;
    }
    
    .pending-count {
      margin-top: 15px;
      padding: 10px 20px;
      background: rgba(255,165,0,0.2);
      border-radius: 8px;
      color: #ffa500;
      font-size: 14px;
      display: none;
    }
    
    .pending-count.show { display: inline-block; }
    
    .analyze-btn {
      margin-top: 15px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: none;
    }
    
    .analyze-btn.show { display: inline-block; }

    /* ===== FILTER SECTION ===== */
    .filter-section {
      padding: 10px 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 13px;
      flex: 1;
      min-width: 100px;
    }

    /* ===== PROJECT MANAGER ===== */
    .project-section {
      padding: 15px 20px;
      background: rgba(0,0,0,0.2);
      margin: 10px 20px;
      border-radius: 12px;
    }
    
    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .project-title {
      font-size: 14px;
      color: #fff;
      font-weight: bold;
    }
    
    .project-add-btn {
      background: rgba(0,212,255,0.3);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      color: #00d4ff;
      font-size: 12px;
      cursor: pointer;
    }
    
    .project-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .project-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
    }
    
    .project-delete {
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      line-height: 1;
    }

    /* ===== RECEIPT LIST ===== */
    .receipt-list { padding: 10px 20px; }
    
    .receipt-card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
    }
    
    .receipt-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    
    .receipt-date {
      font-size: 14px;
      color: #00d4ff;
      font-weight: bold;
    }
    
    .receipt-store {
      font-size: 13px;
      color: rgba(255,255,255,0.8);
    }
    
    .receipt-project {
      font-size: 11px;
      color: #ffa500;
      background: rgba(255,165,0,0.2);
      padding: 3px 8px;
      border-radius: 10px;
      margin-top: 4px;
      display: inline-block;
    }
    
    .receipt-items {
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 10px;
      margin-top: 10px;
    }
    
    .receipt-item {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      padding: 4px 0;
    }
    
    .receipt-total {
      display: flex;
      justify-content: space-between;
      font-size: 16px;
      color: #fff;
      font-weight: bold;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    
    .receipt-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .project-select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 11px;
      flex: 1;
      min-width: 100px;
    }
    
    .delete-btn {
      background: rgba(255,0,0,0.3);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      color: #ff6b6b;
      font-size: 12px;
      cursor: pointer;
    }

    /* ===== SUMMARY ===== */
    .summary-section {
      padding: 15px 20px;
      background: rgba(0,0,0,0.2);
      margin: 10px 20px;
      border-radius: 12px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      padding: 5px 0;
    }
    
    .summary-row.total {
      font-size: 18px;
      color: #fff;
      font-weight: bold;
      border-top: 1px solid rgba(255,255,255,0.2);
      margin-top: 10px;
      padding-top: 10px;
    }

    /* ===== EXPORT SECTION ===== */
    .export-section { padding: 20px; }
    
    .export-card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }
    
    .export-title {
      font-size: 16px;
      color: #fff;
      margin-bottom: 10px;
    }
    
    .export-desc {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 15px;
      line-height: 1.5;
    }
    
    .export-select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .export-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .export-btn.invoice {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: #fff;
    }
    
    .export-btn.ledger {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: #fff;
    }
    
    .export-preview {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      max-height: 200px;
      overflow-y: auto;
    }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.5);
    }
    
    .empty-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      padding: 20px;
    }
    
    .modal-overlay.show { display: flex; }
    
    .modal-box {
      background: #1a1a2e;
      border-radius: 16px;
      padding: 25px;
      max-width: 400px;
      width: 100%;
    }
    
    .modal-title {
      font-size: 18px;
      color: #fff;
      margin-bottom: 15px;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    .modal-btns {
      display: flex;
      gap: 10px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .modal-btn.cancel {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
    
    .modal-btn.confirm {
      background: linear-gradient(135deg, #00d4ff, #9b59b6);
      color: #fff;
    }

    /* ===== LOADING ===== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10002;
      flex-direction: column;
    }
    
    .loading-overlay.show { display: flex; }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text {
      margin-top: 20px;
      color: #fff;
      font-size: 14px;
    }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10003;
      display: none;
      max-width: 90%;
      text-align: center;
    }
    
    .toast.show {
      display: block;
      animation: fadeInOut 2.5s ease;
    }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; }
      10%, 90% { opacity: 1; }
    }
  </style>
</head>
<body>

  <!-- COCOMI Splash -->
  <div id="cocomi-splash">
    <div class="cocomi-content">
      <div class="cocomi-title">COCOMI CORE</div>
      <div class="cocomi-subtitle">Collaborative Cognitive Mind Interface</div>
      <div class="cocomi-sisters">COCOMI Sisters <span class="heart">â™¡</span></div>
      <div class="cocomi-tagline">æƒ³ã„ãŒæ§‹é€ ã«ãªã‚Šã€æ§‹é€ ãŒè¨¼æ˜ã«ãªã‚‹ã€‚</div>
    </div>
  </div>

  <!-- PERAFCA Splash -->
  <div id="perafca-splash">
    <div class="perafca-content">
      <div class="perafca-title">PERAFCA Core</div>
      <div class="perafca-items">
        <div class="perafca-item"><span class="perafca-key">P.E.</span> â”€ Prompt Engineering</div>
        <div class="perafca-item"><span class="perafca-key">R</span> â”€ Retrieval Augmented</div>
        <div class="perafca-item"><span class="perafca-key">A.F.</span> â”€ Agent Framework</div>
        <div class="perafca-item"><span class="perafca-key">C.A.</span> â”€ Cognitive Architecture</div>
      </div>
      <div class="perafca-tagline">
        <svg class="tagline-heart" viewBox="0 0 24 24"><path d="M12,21 C12,21 4,14 4,9 C4,5.5 7,3 10,4.5 C11,5 12,6 12,6 C12,6 13,5 14,4.5 C17,3 20,5.5 20,9 C20,14 12,21 12,21 Z" /></svg>
        å¿ƒãŒç•°ç•Œã‚’ç´¡ãä»•çµ„ã¿
      </div>
    </div>
  </div>

  <!-- API Key Screen -->
  <div id="apikey-screen">
    <div class="apikey-box">
      <div class="apikey-title">ğŸ”‘ Gemini APIã‚­ãƒ¼è¨­å®š</div>
      <div class="apikey-desc">
        ãƒ¬ã‚·ãƒ¼ãƒˆã®AIè§£æã«Gemini APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
        APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
        ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰
      </div>
      <input type="password" id="apikey-input" class="apikey-input" placeholder="AIza...">
      <button class="apikey-btn" onclick="saveApiKey()">ä¿å­˜ã—ã¦é–‹å§‹</button>
    </div>
  </div>

  <!-- Main App -->
  <div id="main-app">
    <div class="app-header">
      <div class="app-title">ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆãƒã‚¹ã‚¿ãƒ¼</div>
      <div class="header-btns">
        <button class="header-btn" onclick="exportBackup()">ğŸ’¾</button>
        <button class="header-btn" onclick="document.getElementById('import-input').click()">ğŸ“‚</button>
        <button class="header-btn" onclick="showApiKeyScreen()">ğŸ”‘</button>
      </div>
      <input type="file" id="import-input" accept=".json" style="display:none" onchange="importBackup(event)">
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="showTab('receipt', this)">ğŸ“‹ ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</button>
      <button class="tab-btn" onclick="showTab('export', this)">ğŸ“¤ å–ã‚Šè¾¼ã¿ãƒ»å‡ºåŠ›</button>
    </div>

    <!-- Tab: Receipt List -->
    <div id="tab-receipt" class="tab-content">
      <div class="camera-section">
        <button class="camera-btn" onclick="document.getElementById('camera-input').click()">
          ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±
        </button>
        <input type="file" id="camera-input" accept="image/*" capture="environment" multiple onchange="handlePhotos(event)">
        
        <div id="pending-photos" class="pending-photos"></div>
        <div id="pending-count" class="pending-count"></div>
        <button id="analyze-btn" class="analyze-btn" onclick="analyzeAllPending()">ğŸ¤– ã¾ã¨ã‚ã¦AIè§£æ</button>
      </div>

      <div class="project-section">
        <div class="project-header">
          <div class="project-title">ğŸ  ç¾å ´ä¸€è¦§</div>
          <button class="project-add-btn" onclick="showAddProjectModal()">ï¼‹ è¿½åŠ </button>
        </div>
        <div id="project-list" class="project-list"></div>
      </div>

      <div class="filter-section">
        <select id="filter-project" class="filter-select" onchange="renderReceipts()">
          <option value="">ğŸ  å…¨ã¦ã®ç¾å ´</option>
        </select>
        <select id="filter-store" class="filter-select" onchange="renderReceipts()">
          <option value="">ğŸª å…¨ã¦ã®åº—èˆ—</option>
        </select>
        <select id="sort-order" class="filter-select" onchange="renderReceipts()">
          <option value="desc">ğŸ“… æ–°ã—ã„é †</option>
          <option value="asc">ğŸ“… å¤ã„é †</option>
        </select>
      </div>

      <div class="summary-section">
        <div class="summary-row">
          <span>ãƒ¬ã‚·ãƒ¼ãƒˆæ•°</span>
          <span id="summary-count">0ä»¶</span>
        </div>
        <div class="summary-row">
          <span>å°è¨ˆ</span>
          <span id="summary-subtotal">Â¥0</span>
        </div>
        <div class="summary-row">
          <span>æ¶ˆè²»ç¨</span>
          <span id="summary-tax">Â¥0</span>
        </div>
        <div class="summary-row total">
          <span>åˆè¨ˆ</span>
          <span id="summary-total">Â¥0</span>
        </div>
      </div>

      <div id="receipt-list" class="receipt-list"></div>
    </div>

    <!-- Tab: Export -->
    <div id="tab-export" class="tab-content" style="display:none;">
      <div class="export-section">
        
        <div class="export-card">
          <div class="export-title">ğŸ“„ è¦‹ç©æ›¸ãƒ»è«‹æ±‚æ›¸ç”¨ã«å–ã‚Šè¾¼ã‚€</div>
          <div class="export-desc">
            é¸æŠã—ãŸç¾å ´ã®ææ–™è²»åˆè¨ˆã‚’å‡ºåŠ›ã—ã¾ã™ã€‚<br>
            ã€Œææ–™è²»ä¸€å¼ã€ã¨ã—ã¦è¨ˆä¸Šã§ãã¾ã™ã€‚
          </div>
          <select id="export-invoice-project" class="export-select" onchange="updateInvoicePreview()">
            <option value="">ç¾å ´ã‚’é¸æŠ...</option>
          </select>
          <div id="invoice-preview" class="export-preview" style="display:none;"></div>
          <button class="export-btn invoice" onclick="exportForInvoice()">ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¦å–ã‚Šè¾¼ã‚€</button>
        </div>

        <div class="export-card">
          <div class="export-title">ğŸ“’ å‡ºç´å¸³ç”¨ã«å‡ºåŠ›</div>
          <div class="export-desc">
            ãƒ¬ã‚·ãƒ¼ãƒˆè©³ç´°ã‚’ãã®ã¾ã¾å‡ºåŠ›ã—ã¾ã™ã€‚<br>
            æ—¥ä»˜ãƒ»åº—èˆ—ãƒ»å“åãƒ»é‡‘é¡ã™ã¹ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
          </div>
          <select id="export-ledger-project" class="export-select" onchange="updateLedgerPreview()">
            <option value="">ç¾å ´ã‚’é¸æŠï¼ˆå…¨ã¦ãªã‚‰ç©ºæ¬„ï¼‰...</option>
          </select>
          <div id="ledger-preview" class="export-preview" style="display:none;"></div>
          <button class="export-btn ledger" onclick="exportForLedger()">ğŸ“¥ å‡ºç´å¸³ç”¨JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Add Project Modal -->
  <div id="project-modal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-title">ğŸ  ç¾å ´ã‚’è¿½åŠ </div>
      <input type="text" id="project-name-input" class="modal-input" placeholder="ä¾‹ï¼šâ—‹â—‹æ§˜é‚¸ã€â–³â–³å·¥äº‹">
      <div class="modal-btns">
        <button class="modal-btn cancel" onclick="hideProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn confirm" onclick="addProject()">è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">AIè§£æä¸­...</div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    const SPLASH_CONFIG = { splash1Duration: 4000, splash2Duration: 3500, fadeDuration: 800 };
    const STORAGE_KEYS = { apiKey: 'cocomi_receipt_apikey', receipts: 'cocomi_receipt_master', projects: 'cocomi_receipt_projects' };

    let receipts = [];
    let projects = [];
    let pendingPhotos = [];
    let apiKey = '';

    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      startSplashSequence();
    });

    function startSplashSequence() {
      const cocomiSplash = document.getElementById('cocomi-splash');
      const perafcaSplash = document.getElementById('perafca-splash');
      
      setTimeout(function() {
        cocomiSplash.classList.add('fade-out');
        setTimeout(() => perafcaSplash.classList.add('active'), 100);
        setTimeout(function() {
          cocomiSplash.style.display = 'none';
          setTimeout(function() {
            perafcaSplash.classList.add('fade-out');
            setTimeout(function() {
              perafcaSplash.style.display = 'none';
              checkApiKeyAndShowApp();
            }, SPLASH_CONFIG.fadeDuration);
          }, SPLASH_CONFIG.splash2Duration);
        }, SPLASH_CONFIG.fadeDuration);
      }, SPLASH_CONFIG.splash1Duration);
    }

    function checkApiKeyAndShowApp() {
      apiKey = localStorage.getItem(STORAGE_KEYS.apiKey) || '';
      if (!apiKey) {
        document.getElementById('apikey-screen').classList.add('active');
      } else {
        showMainApp();
      }
    }

    function saveApiKey() {
      const input = document.getElementById('apikey-input').value.trim();
      if (!input) { showToast('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      apiKey = input;
      localStorage.setItem(STORAGE_KEYS.apiKey, apiKey);
      document.getElementById('apikey-screen').classList.remove('active');
      showMainApp();
      showToast('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function showApiKeyScreen() {
      document.getElementById('apikey-input').value = apiKey;
      document.getElementById('apikey-screen').classList.add('active');
      document.getElementById('main-app').classList.remove('active');
    }

    function showMainApp() {
      document.getElementById('main-app').classList.add('active');
      renderAll();
    }

    function showTab(tabName, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      btn.classList.add('active');
      document.getElementById('tab-' + tabName).style.display = 'block';
      if (tabName === 'export') updateExportSelects();
    }

    function loadData() {
      try { receipts = JSON.parse(localStorage.getItem(STORAGE_KEYS.receipts)) || []; } catch(e) { receipts = []; }
      try { projects = JSON.parse(localStorage.getItem(STORAGE_KEYS.projects)) || []; } catch(e) { projects = []; }
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEYS.receipts, JSON.stringify(receipts));
      localStorage.setItem(STORAGE_KEYS.projects, JSON.stringify(projects));
    }

    function exportBackup() {
      const data = { version: '2.0', exported: new Date().toISOString(), receipts, projects };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `receipt_master_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      showToast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function importBackup(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.receipts) receipts = data.receipts;
          if (data.projects) projects = data.projects;
          saveData();
          renderAll();
          showToast(`å¾©å…ƒã—ã¾ã—ãŸï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆ${receipts.length}ä»¶ã€ç¾å ´${projects.length}ä»¶ï¼‰`);
        } catch (err) { showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function showAddProjectModal() {
      document.getElementById('project-name-input').value = '';
      document.getElementById('project-modal').classList.add('show');
    }

    function hideProjectModal() {
      document.getElementById('project-modal').classList.remove('show');
    }

    function addProject() {
      const name = document.getElementById('project-name-input').value.trim();
      if (!name) { showToast('ç¾å ´åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if (projects.includes(name)) { showToast('åŒã˜åå‰ã®ç¾å ´ãŒã‚ã‚Šã¾ã™'); return; }
      projects.push(name);
      saveData();
      renderProjects();
      updateFilters();
      hideProjectModal();
      showToast('ç¾å ´ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    function deleteProject(name) {
      if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      projects = projects.filter(p => p !== name);
      receipts.forEach(r => { if (r.projectName === name) r.projectName = ''; });
      saveData();
      renderAll();
      showToast('ç¾å ´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    function renderProjects() {
      const el = document.getElementById('project-list');
      if (projects.length === 0) {
        el.innerHTML = '<span style="color:rgba(255,255,255,0.5);font-size:12px;">ç¾å ´ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</span>';
        return;
      }
      el.innerHTML = projects.map(p => `
        <div class="project-tag">
          <span>${p}</span>
          <button class="project-delete" onclick="deleteProject('${p}')">Ã—</button>
        </div>
      `).join('');
    }

    function handlePhotos(event) {
      const files = event.target.files;
      for (let i = 0; i < files.length; i++) {
        const reader = new FileReader();
        reader.onload = e => { pendingPhotos.push(e.target.result); updatePendingUI(); };
        reader.readAsDataURL(files[i]);
      }
      event.target.value = '';
    }

    function updatePendingUI() {
      const photosEl = document.getElementById('pending-photos');
      const countEl = document.getElementById('pending-count');
      const analyzeBtn = document.getElementById('analyze-btn');
      
      if (pendingPhotos.length > 0) {
        photosEl.innerHTML = pendingPhotos.map((p, i) => `<img src="${p}" class="pending-photo">`).join('');
        countEl.textContent = `ğŸ“· ${pendingPhotos.length}æšã®å†™çœŸãŒå¾…æ©Ÿä¸­`;
        countEl.classList.add('show');
        analyzeBtn.classList.add('show');
      } else {
        photosEl.innerHTML = '';
        countEl.classList.remove('show');
        analyzeBtn.classList.remove('show');
      }
    }

    async function analyzeAllPending() {
      alert('STEP1: ãƒœã‚¿ãƒ³æŠ¼ã•ã‚ŒãŸï¼');
      
      if (!apiKey) { showToast('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
      if (pendingPhotos.length === 0) { showToast('æ’®å½±ã—ãŸå†™çœŸãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      
      alert('STEP2: APIã‚­ãƒ¼OKã€å†™çœŸ' + pendingPhotos.length + 'æš');
      
      showLoading(`AIè§£æä¸­... (0/${pendingPhotos.length})`);
      let successCount = 0;
      let lastError = '';
      
      for (let i = 0; i < pendingPhotos.length; i++) {
        updateLoadingText(`AIè§£æä¸­... (${i + 1}/${pendingPhotos.length})`);
        try {
          alert('STEP3: APIå‘¼ã³å‡ºã—é–‹å§‹...');
          const result = await analyzeReceipt(pendingPhotos[i]);
          alert('STEP4: APIçµæœ=' + (result ? 'ã‚ã‚Š' : 'ãªã—'));
          if (result) {
            result.id = 'RCP-' + Date.now() + '-' + i;
            result.photo = pendingPhotos[i];
            result.projectName = '';
            result.createdAt = new Date().toISOString();
            receipts.push(result);
            successCount++;
          }
        } catch (err) { 
          alert('STEP-ERROR: ' + err.message);
          console.error('è§£æã‚¨ãƒ©ãƒ¼:', err);
          lastError = err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
        }
      }
      
      pendingPhotos = [];
      updatePendingUI();
      saveData();
      renderReceipts();
      hideLoading();
      
      if (successCount > 0) {
        showToast(`${successCount}ä»¶ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
      } else if (lastError) {
        showToast(`ã‚¨ãƒ©ãƒ¼: ${lastError}`);
      } else {
        showToast('è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
    }

    async function analyzeReceipt(base64Image) {
      alert('API-1: analyzeReceipté–‹å§‹');
      const imageData = base64Image.replace(/^data:image\/\w+;base64,/, '');
      const prompt = `ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’è§£æã—ã¦ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚å¿…ãšæœ‰åŠ¹ãªJSONã®ã¿ã‚’å‡ºåŠ›ã—ã€ä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚
{
  "date": "YYYY-MM-DDå½¢å¼ã®æ—¥ä»˜",
  "store": "åº—èˆ—å",
  "items": [{ "name": "å•†å“å", "qty": æ•°é‡, "price": å˜ä¾¡, "total": å°è¨ˆ }],
  "subtotal": ç¨æŠœå°è¨ˆ,
  "tax": æ¶ˆè²»ç¨,
  "total": åˆè¨ˆé‡‘é¡
}
èª­ã¿å–ã‚Œãªã„é …ç›®ã¯nullã¨ã—ã¦ãã ã•ã„ã€‚`;

      let response;
      try {
        alert('API-2: fetché–‹å§‹');
        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: 'image/jpeg', data: imageData } }] }],
            generationConfig: { temperature: 0.1, maxOutputTokens: 2048 }
          })
        });
        alert('API-3: fetchå®Œäº†, status=' + response.status);
      } catch (fetchErr) {
        alert('API-ERROR-FETCH: ' + fetchErr.message);
        throw new Error('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + fetchErr.message);
      }

      const data = await response.json();
      alert('API-4: JSONå–å¾—, keys=' + Object.keys(data).join(','));
      
      // APIã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
      if (data.error) {
        alert('API-ERROR: ' + JSON.stringify(data.error));
        throw new Error('API: ' + (data.error.message || data.error.status || 'ã‚¨ãƒ©ãƒ¼'));
      }
      
      if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
        const text = data.candidates[0].content.parts[0].text;
        alert('API-5: ãƒ†ã‚­ã‚¹ãƒˆå–å¾—, é•·ã•=' + text.length);
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          try {
            const result = JSON.parse(jsonMatch[0]);
            alert('API-6: ãƒ‘ãƒ¼ã‚¹æˆåŠŸ!');
            return result;
          } catch (parseErr) {
            alert('API-ERROR-PARSE: ' + parseErr.message);
            throw new Error('JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—');
          }
        } else {
          alert('API-ERROR: JSONãŒè¦‹ã¤ã‹ã‚‰ãªã„, text=' + text.substring(0, 100));
          throw new Error('JSONå½¢å¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„');
        }
      }
      
      alert('API-ERROR: å¿œç­”å½¢å¼ä¸æ­£, data=' + JSON.stringify(data).substring(0, 200));
      throw new Error('å¿œç­”å½¢å¼ãŒä¸æ­£');
    }

    function renderAll() {
      renderProjects();
      updateFilters();
      renderReceipts();
    }

    function updateFilters() {
      const projectSelect = document.getElementById('filter-project');
      const storeSelect = document.getElementById('filter-store');
      const currentProject = projectSelect.value;
      const currentStore = storeSelect.value;
      
      projectSelect.innerHTML = '<option value="">ğŸ  å…¨ã¦ã®ç¾å ´</option>' + projects.map(p => `<option value="${p}" ${p === currentProject ? 'selected' : ''}>${p}</option>`).join('');
      
      const stores = [...new Set(receipts.map(r => r.store).filter(Boolean))];
      storeSelect.innerHTML = '<option value="">ğŸª å…¨ã¦ã®åº—èˆ—</option>' + stores.map(s => `<option value="${s}" ${s === currentStore ? 'selected' : ''}>${s}</option>`).join('');
    }

    function renderReceipts() {
      const listEl = document.getElementById('receipt-list');
      const filterProject = document.getElementById('filter-project').value;
      const filterStore = document.getElementById('filter-store').value;
      const sortOrder = document.getElementById('sort-order').value;
      
      let filtered = receipts.filter(r => {
        if (filterProject && r.projectName !== filterProject) return false;
        if (filterStore && r.store !== filterStore) return false;
        return true;
      });
      
      filtered.sort((a, b) => {
        const dateA = new Date(a.date || a.createdAt);
        const dateB = new Date(b.date || b.createdAt);
        return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
      });
      
      updateSummary(filtered);
      
      if (filtered.length === 0) {
        listEl.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“·</div><p>ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„</p></div>`;
        return;
      }
      
      listEl.innerHTML = filtered.map(r => `
        <div class="receipt-card">
          <div class="receipt-header">
            <div>
              <div class="receipt-date">${formatDate(r.date)}</div>
              <div class="receipt-store">${r.store || 'ä¸æ˜ãªåº—èˆ—'}</div>
              ${r.projectName ? `<div class="receipt-project">ğŸ  ${r.projectName}</div>` : ''}
            </div>
          </div>
          <div class="receipt-items">
            ${(r.items || []).slice(0,5).map(item => `<div class="receipt-item"><span>${item.name} Ã— ${item.qty || 1}</span><span>Â¥${(item.total || 0).toLocaleString()}</span></div>`).join('')}
            ${(r.items?.length || 0) > 5 ? `<div class="receipt-item" style="color:#ffa500;">...ä»–${r.items.length - 5}ç‚¹</div>` : ''}
          </div>
          <div class="receipt-total"><span>åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</span><span>Â¥${(r.total || 0).toLocaleString()}</span></div>
          <div class="receipt-footer">
            <select class="project-select" onchange="updateReceiptProject('${r.id}', this.value)">
              <option value="">ğŸ  ç¾å ´ã‚’é¸æŠ</option>
              ${projects.map(p => `<option value="${p}" ${r.projectName === p ? 'selected' : ''}>${p}</option>`).join('')}
            </select>
            <button class="delete-btn" onclick="deleteReceipt('${r.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
    }

    function updateSummary(filtered) {
      document.getElementById('summary-count').textContent = `${filtered.length}ä»¶`;
      document.getElementById('summary-subtotal').textContent = `Â¥${filtered.reduce((s,r) => s + (r.subtotal||0), 0).toLocaleString()}`;
      document.getElementById('summary-tax').textContent = `Â¥${filtered.reduce((s,r) => s + (r.tax||0), 0).toLocaleString()}`;
      document.getElementById('summary-total').textContent = `Â¥${filtered.reduce((s,r) => s + (r.total||0), 0).toLocaleString()}`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'æ—¥ä»˜ä¸æ˜';
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return `${d.getMonth()+1}/${d.getDate()}ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]}ï¼‰`;
    }

    function updateReceiptProject(id, projectName) {
      const r = receipts.find(x => x.id === id);
      if (r) { r.projectName = projectName; saveData(); renderReceipts(); showToast('ç¾å ´ã‚’è¨­å®šã—ã¾ã—ãŸ'); }
    }

    function deleteReceipt(id) {
      if (!confirm('ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      receipts = receipts.filter(r => r.id !== id);
      saveData();
      renderReceipts();
      showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    function updateExportSelects() {
      const opts = '<option value="">ç¾å ´ã‚’é¸æŠ...</option>' + projects.map(p => `<option value="${p}">${p}</option>`).join('');
      document.getElementById('export-invoice-project').innerHTML = opts;
      document.getElementById('export-ledger-project').innerHTML = '<option value="">å…¨ã¦ã®ç¾å ´</option>' + projects.map(p => `<option value="${p}">${p}</option>`).join('');
    }

    function updateInvoicePreview() {
      const project = document.getElementById('export-invoice-project').value;
      const previewEl = document.getElementById('invoice-preview');
      if (!project) { previewEl.style.display = 'none'; return; }
      
      const projectReceipts = receipts.filter(r => r.projectName === project);
      const total = projectReceipts.reduce((s,r) => s + (r.total||0), 0);
      const tax = projectReceipts.reduce((s,r) => s + (r.tax||0), 0);
      
      previewEl.style.display = 'block';
      previewEl.innerHTML = `<strong>ğŸ“„ ${project}</strong><br><br>ãƒ¬ã‚·ãƒ¼ãƒˆæ•°: ${projectReceipts.length}ä»¶<br>ææ–™è²»ï¼ˆç¨æŠœï¼‰: Â¥${(total-tax).toLocaleString()}<br>æ¶ˆè²»ç¨: Â¥${tax.toLocaleString()}<br><strong>åˆè¨ˆ: Â¥${total.toLocaleString()}</strong><br><br>â€»ã€Œææ–™è²»ä¸€å¼ Â¥${total.toLocaleString()}ã€ã¨ã—ã¦è¨ˆä¸Šã§ãã¾ã™`;
    }

    function exportForInvoice() {
      const project = document.getElementById('export-invoice-project').value;
      if (!project) { showToast('ç¾å ´ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      
      const projectReceipts = receipts.filter(r => r.projectName === project);
      const total = projectReceipts.reduce((s,r) => s + (r.total||0), 0);
      
      const data = { type: 'invoice_material', projectName: project, description: 'ææ–™è²»ä¸€å¼', total, receiptCount: projectReceipts.length, exportedAt: new Date().toISOString() };
      
      navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
        showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      }).catch(() => {
        prompt('ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', `${project}\nææ–™è²»ä¸€å¼: Â¥${total.toLocaleString()}`);
      });
    }

    function updateLedgerPreview() {
      const project = document.getElementById('export-ledger-project').value;
      const previewEl = document.getElementById('ledger-preview');
      const filtered = project ? receipts.filter(r => r.projectName === project) : receipts;
      
      if (filtered.length === 0) { previewEl.style.display = 'block'; previewEl.innerHTML = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'; return; }
      
      const total = filtered.reduce((s,r) => s + (r.total||0), 0);
      const itemCount = filtered.reduce((s,r) => s + (r.items?.length||0), 0);
      
      previewEl.style.display = 'block';
      previewEl.innerHTML = `<strong>ğŸ“’ å‡ºç´å¸³ç”¨ãƒ‡ãƒ¼ã‚¿</strong><br><br>${project ? `ç¾å ´: ${project}<br>` : ''}ãƒ¬ã‚·ãƒ¼ãƒˆæ•°: ${filtered.length}ä»¶<br>æ˜ç´°æ•°: ${itemCount}ä»¶<br>åˆè¨ˆé‡‘é¡: Â¥${total.toLocaleString()}`;
    }

    function exportForLedger() {
      const project = document.getElementById('export-ledger-project').value;
      const filtered = project ? receipts.filter(r => r.projectName === project) : receipts;
      
      if (filtered.length === 0) { showToast('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      
      const entries = [];
      filtered.forEach(r => {
        (r.items || []).forEach(item => {
          entries.push({ date: r.date, store: r.store, projectName: r.projectName || '', itemName: item.name, qty: item.qty || 1, price: item.price || 0, total: item.total || 0, receiptId: r.id });
        });
      });
      
      const data = { type: 'ledger_entries', projectName: project || 'å…¨ç¾å ´', entries, summary: { receiptCount: filtered.length, entryCount: entries.length, total: filtered.reduce((s,r) => s + (r.total||0), 0) }, exportedAt: new Date().toISOString() };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ledger_${project || 'all'}_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      showToast('å‡ºç´å¸³ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
    }

    function showLoading(text) { document.getElementById('loading-text').textContent = text; document.getElementById('loading').classList.add('show'); }
    function updateLoadingText(text) { document.getElementById('loading-text').textContent = text; }
    function hideLoading() { document.getElementById('loading').classList.remove('show'); }
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.remove('show');
      void t.offsetWidth;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }
  </script>

  <script>
    // Service Workerç™»éŒ²
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('SW registered'))
        .catch(err => console.log('SW registration failed:', err));
    }
  </script>
</body>
</html>
